<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Word - Pro Edition</title>
    <style>
        :root {
            --mario-red: #ff0000;
            --sky-blue: #5c94fc;
            --brick: #944824;
            --gold: #f1c40f;
        }

        body {
            margin: 0;
            font-family: 'Courier New', monospace;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é¡¶éƒ¨æ§åˆ¶é¢æ¿ */
        #setup-bar {
            width: 100%;
            background: #444;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            border-bottom: 4px solid var(--mario-red);
        }

        .setting-group { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        select, button { padding: 8px; border: 2px solid #000; cursor: pointer; font-weight: bold; }
        
        .upload-btn { background: #27ae60; color: white; border: none; }
        .start-btn { background: var(--mario-red); color: white; border: none; padding: 10px 20px; }
        .active-custom { border: 2px solid #2ecc71; position: relative; }
        .active-custom::after { content: " (å·²é”å®šè‡ªå®šä¹‰)"; font-size: 10px; color: #2ecc71; }

        /* æ¸¸æˆä¸»å®¹å™¨ */
        #game-stage {
            width: 800px;
            height: 400px;
            background: var(--sky-blue);
            position: relative;
            margin-top: 20px;
            border: 6px solid #fff;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            image-rendering: pixelated;
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40px;
            background: repeating-linear-gradient(90deg, var(--brick), var(--brick) 40px, #6b341a 40px, #6b341a 80px);
        }

        /* è§’è‰²æ ·å¼ */
        .char { position: absolute; bottom: 40px; font-size: 70px; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        #mario { left: 80px; transition: 0.3s; animation: bounce 0.6s infinite alternate; }
        #mario.hurt { animation: shake 0.1s infinite; filter: grayscale(1) invert(1); }
        #mario.super { filter: drop-shadow(0 0 15px gold); transform: scale(1.2); }
        
        #boss { right: 80px; }
        .hp-container { width: 100px; height: 12px; background: #333; border: 2px solid #000; margin-bottom: 5px; }
        #hp-bar { width: 100%; height: 100%; background: #2ecc71; transition: width 0.3s; }
        .boss-angry { animation: flash 0.3s infinite; }

        /* è¾“å…¥åŒºåŸŸ */
        #ui-area { margin-top: 20px; text-align: center; }
        #word-input { font-size: 28px; padding: 10px; width: 400px; text-align: center; border: 4px solid var(--brick); border-radius: 8px; outline: none; }
        
        .stats-info { display: flex; gap: 30px; margin: 15px 0; font-size: 18px; color: var(--gold); }
        .hint { color: #aaa; font-size: 14px; margin-top: 10px; }

        /* åŠ¨ç”» */
        @keyframes bounce { from { bottom: 40px; } to { bottom: 55px; } }
        @keyframes shake { 0% { transform: translateX(-10px); } 100% { transform: translateX(10px); } }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes fireball-fly { 0% { left: 150px; opacity: 1; } 100% { left: 650px; opacity: 0; } }

        .fireball { position: absolute; bottom: 80px; font-size: 30px; animation: fireball-fly 0.5s linear forwards; z-index: 5; }

        /* è¦†ç›–å±‚ */
        #overlay {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 30px;
            border: 4px solid var(--gold);
            z-index: 1000;
            width: 500px;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="setup-bar">
    <div class="setting-group" id="grade-container">
        <label>è¯åº“:</label>
        <select id="grade-select">
            <option value="3">NAPLAN Grade 3</option>
            <option value="5">NAPLAN Grade 5</option>
            <option value="7">NAPLAN Grade 7</option>
            <option value="9">NAPLAN Grade 9</option>
        </select>
    </div>

    <input type="file" id="file-input" style="display:none" accept=".json,.txt">
    <button class="upload-btn" onclick="document.getElementById('file-input').click()">ğŸ“ ä¸Šä¼ è‡ªå®šä¹‰è¯åº“</button>

    <div class="setting-group">
        <label>æ€»å…³å¡:</label>
        <select id="set-levels"><option value="3">3</option><option value="5">5</option><option value="10">10</option></select>
    </div>
    
    <div class="setting-group">
        <label>è¯æ•°/å…³:</label>
        <select id="set-words"><option value="10">10</option><option value="15" selected>15</option><option value="20">20</option></select>
    </div>

    <button class="start-btn" onclick="game.startNewGame()">å¼€å§‹æ¸¸æˆ</button>
</div>

<div class="stats-info">
    <span>LEVEL: <b id="ui-level">1</b></span>
    <span>COINS: <b id="ui-coins">0</b></span>
    <span>COMBO: <b id="ui-combo">0</b></span>
</div>

<div id="game-stage">
    <div id="mario" class="char">ğŸ‘°ğŸ»â€â™€ï¸</div>
    <div id="boss" class="char">
        <div class="hp-container"><div id="hp-bar"></div></div>
        <div id="boss-emoji">ğŸ²</div>
    </div>
    <div class="ground"></div>
</div>

<div id="ui-area">
    <input type="text" id="word-input" placeholder="ç‚¹å‡»å¼€å§‹æ¸¸æˆ..." autocomplete="off" disabled>
    <p class="hint">ã€Enterã€‘ç¡®è®¤æäº¤ | ã€ç©ºæ ¼é”® Spaceã€‘é‡å¬å•è¯</p>
</div>

<div id="overlay">
    <h1 id="over-title">LEVEL CLEAR</h1>
    <div id="over-body"></div>
    <br>
    <button onclick="game.closeOverlay()" style="padding: 10px 30px; cursor:pointer;">ç‚¹å‡»ç»§ç»­</button>
</div>

<script>
/**
 * é»˜è®¤è¯åº“ (ç¤ºä¾‹)
 */
const DEFAULT_DB = {
    3: ["apple", "bread", "chair", "dance", "earth", "fruit", "green", "house", "island", "juice", "knife", "lemon", "music", "night", "ocean", "paper", "queen", "river", "smile", "table"],
    5: ["absence", "boundary", "calendar", "describe", "evidence", "frequency", "government", "horizon", "instance", "journey", "knowledge", "language", "measure", "negative", "opposite", "physical", "quality", "resource", "science", "thousand"],
    7: ["abandon", "beneficial", "capacity", "drastic", "efficient", "flexible", "generate", "highlight", "indicate", "justify", "liberty", "majority", "notable", "objective", "precise", "relevant", "sustainable", "tendency", "ultimate", "variation"],
    9: ["aesthetic", "benevolent", "conjecture", "deteriorate", "eloquent", "fluctuate", "gregarious", "hierarchy", "idiosyncrasy", "juxtapose", "kinship", "labyrinth", "meticulous", "nostalgia", "obfuscate", "pragmatic", "quarantine", "resilient", "scrutinize", "transient"]
};

const BOSSES = ["ğŸ²", "ğŸ‘¹", "ğŸ‘¾", "ğŸ‘»", "ğŸ§Ÿâ€â™‚ï¸", "ğŸ™", "ğŸ§›ğŸ»â€â™€ï¸", "ğŸ¦‡", "ğŸ¤¡", "ğŸ¦–"];

const game = {
    customWords: null, 
    usedWords: new Set(), // è®°å¿†å·²ä½¿ç”¨çš„å•è¯ï¼Œé˜²æ­¢è·¨å…³å¡é‡å¤
    level: 1,
    coins: 0,
    combo: 0,
    currentWords: [],
    currentIndex: 0,
    correctCount: 0,
    mistakes: [],
    
    startNewGame() {
        this.level = 1;
        this.coins = 0;
        this.mistakes = [];
        this.usedWords.clear(); // æ¸¸æˆé‡æ–°å¼€å§‹ï¼Œé‡ç½®å»é‡æ± 
        
        this.totalLevels = parseInt(document.getElementById('set-levels').value);
        this.wordsPerLevel = parseInt(document.getElementById('set-words').value);
        
        document.getElementById('word-input').disabled = false;
        document.getElementById('word-input').focus();
        
        this.initLevel();
    },

    initLevel() {
        const grade = document.getElementById('grade-select').value;
        const pool = this.customWords ? this.customWords : DEFAULT_DB[grade];
        
        // æ ¸å¿ƒï¼šè¿‡æ»¤æ‰æœ¬åœºæ¯”èµ›å·²ç»å‡ºç°è¿‡çš„å•è¯
        let availablePool = pool.filter(w => !this.usedWords.has(w));
        
        // å¦‚æœè¯åº“ä¸å¤Ÿç”¨äº†ï¼Œé‡ç½®ä¸€ä¸‹æ± å­ï¼ˆå…œåº•é€»è¾‘ï¼‰
        if (availablePool.length < this.wordsPerLevel) {
            this.usedWords.clear();
            availablePool = pool;
        }

        this.currentIndex = 0;
        this.correctCount = 0;
        this.combo = 0;
        
        // éšæœºæŠ½é€‰ä¸é‡å¤çš„è¯
        this.currentWords = [...availablePool].sort(() => Math.random() - 0.5).slice(0, this.wordsPerLevel);
        
        // æ ‡è®°ä¸ºå·²ä½¿ç”¨
        this.currentWords.forEach(w => this.usedWords.add(w));

        this.resetStageVisuals();
        this.updateUI();
        this.playTone(440, 0.1); 
        this.loadWord();
    },

    loadWord() {
        if (this.currentIndex >= this.wordsPerLevel) {
            this.handleLevelEnd();
            return;
        }
        this.speak(this.currentWords[this.currentIndex]);
        document.getElementById('word-input').value = "";
    },

    speak(word) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(word);
        msg.rate = 0.75;
        msg.lang = 'en-US';
        window.speechSynthesis.speak(msg);
    },

    checkAnswer() {
        const input = document.getElementById('word-input').value.trim().toLowerCase();
        const target = this.currentWords[this.currentIndex].toLowerCase();
        
        if (input === target) {
            this.onCorrect();
        } else {
            this.onWrong(input, target);
        }

        this.currentIndex++;
        setTimeout(() => this.loadWord(), 800);
    },

    onCorrect() {
        this.coins += 10;
        this.combo++;
        this.correctCount++;
        this.createFireball();
        this.playTone(600, 0.1);
        if (this.combo >= 3) document.getElementById('mario').classList.add('super');
        
        const hp = 100 - (this.currentIndex + 1) / this.wordsPerLevel * 100;
        document.getElementById('hp-bar').style.width = hp + "%";
        if (hp < 40) document.getElementById('boss').classList.add('boss-angry');
        this.updateUI();
    },

    onWrong(input, target) {
        this.combo = 0;
        this.coins = Math.max(0, this.coins - 5);
        this.mistakes.push({ word: target, user: input || "[ç©ºç™½]" });
        
        const m = document.getElementById('mario');
        m.classList.remove('super');
        m.classList.add('hurt');
        this.playTone(150, 0.4);
        setTimeout(() => m.classList.remove('hurt'), 500);
        this.updateUI();
    },

    handleLevelEnd() {
        const rate = (this.correctCount / this.wordsPerLevel) * 100;
        const isPass = rate >= 80;
        const ov = document.getElementById('overlay');
        
        if (isPass) {
            if (this.level >= this.totalLevels) {
                this.showFinalCertificate();
            } else {
                document.getElementById('over-title').innerText = "LEVEL COMPLETE!";
                document.getElementById('over-body').innerHTML = `æ­£ç¡®ç‡: ${rate}% <br> å‡†å¤‡å¥½æŒ‘æˆ˜ä¸‹ä¸€å…³äº†å—ï¼Ÿ`;
                ov.style.display = "block";
            }
        } else {
            document.getElementById('over-title').innerText = "æŒ‘æˆ˜å¤±è´¥";
            document.getElementById('over-body').innerHTML = `æ­£ç¡®ç‡ä¸è¶³ 80% (${rate}%) <br> ä¸ºäº†å˜å¼ºï¼Œè¯·é‡å¤æœ¬å…³ç»ƒä¹ ï¼`;
            // å¦‚æœæ²¡è¿‡å…³ï¼Œä¸ºäº†è®©ç”¨æˆ·ç»ƒä¹ ï¼Œè¦æŠŠè¿™ç»„è¯ä»â€œå·²ç”¨â€é‡Œåå‡ºæ¥ä¸€éƒ¨åˆ†ï¼Œä¸‹æ¬¡å¯èƒ½è¿˜ä¼šç»ƒåˆ°
            this.currentWords.forEach(w => this.usedWords.delete(w));
            ov.style.display = "block";
        }
    },

    showFinalCertificate() {
        document.getElementById('over-title').innerText = "ğŸ‘‘ Word Queen ğŸ‘‘";
        let msHtml = this.mistakes.map(m => `<li>${m.word} <span style="color:#e74c3c">(ä½ å†™æˆäº†: ${m.user})</span></li>`).join('');
        document.getElementById('over-body').innerHTML = `
            <h3>Congrats on passing ${this.totalLevels} levelsï¼</h3>
            <p>Final Coins: ${this.coins} ğŸª™</p>
            <div style="text-align:left; background:#111; padding:15px; font-size:13px; max-height:150px; overflow-y:auto;">
                <b>Review List:</b><ul>${msHtml || 'All correctï¼Œyou are the true words masterï¼'}</ul>
            </div>
        `;
        document.getElementById('overlay').style.display = "block";
    },

    closeOverlay() {
        const rate = (this.correctCount / this.wordsPerLevel) * 100;
        document.getElementById('overlay').style.display = "none";
        
        if (rate >= 80) {
            if (this.level < this.totalLevels) {
                this.level++;
                this.initLevel(); // ä¼šè‡ªåŠ¨è¿‡æ»¤æ‰å·²ç”¨å•è¯
            } else {
                // é€šå…³åç‚¹ç»§ç»­å›åˆ°åˆå§‹çŠ¶æ€
                location.reload();
            }
        } else {
            this.initLevel(); // é‡æ–°å¼€å§‹å½“å‰å…³
        }
    },

    resetStageVisuals() {
        document.getElementById('hp-bar').style.width = "100%";
        document.getElementById('boss').classList.remove('boss-angry');
        document.getElementById('boss-emoji').innerText = BOSSES[(this.level-1) % BOSSES.length];
        document.getElementById('mario').classList.remove('super');
    },

    updateUI() {
        document.getElementById('ui-level').innerText = this.level;
        document.getElementById('ui-coins').innerText = this.coins;
        document.getElementById('ui-combo').innerText = this.combo;
    },

    createFireball() {
        const fb = document.createElement('div');
        fb.className = 'fireball';
        fb.innerText = 'ğŸ”¥';
        document.getElementById('game-stage').appendChild(fb);
        setTimeout(() => fb.remove(), 500);
    },

    playTone(freq, duration) {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        } catch(e) {}
    }
};

// è¾“å…¥æ¡†å¿«æ·é”®ç›‘å¬
document.getElementById('word-input').addEventListener('keydown', function(e) {
    if (e.code === 'Space') {
        e.preventDefault(); // å…³é”®ï¼šé˜»æ­¢ç©ºæ ¼è¾“å…¥åˆ°è¾“å…¥æ¡†
        game.speak(game.currentWords[game.currentIndex]);
    }
    if (e.key === 'Enter') {
        game.checkAnswer();
    }
});

// æ–‡ä»¶ä¸Šä¼ 
document.getElementById('file-input').onchange = function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(ev) {
        let words = [];
        try {
            words = JSON.parse(ev.target.result);
        } catch {
            words = ev.target.result.split(/\r?\n/).map(s => s.trim()).filter(s => s.length > 0);
        }
        if (words.length > 0) {
            game.customWords = words;
            document.getElementById('grade-container').classList.add('active-custom');
            document.getElementById('grade-select').disabled = true;
            alert(`è‡ªå®šä¹‰è¯åº“åŠ è½½æˆåŠŸï¼Œå…± ${words.length} è¯ï¼`);
        }
    };
    reader.readAsText(file);
};
</script>
</body>
</html>